name: Version Bump

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_type:
        description: 'バージョンタイプ'
        required: true
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
        default: 'auto'

concurrency:
  group: version-bump
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  bump:
    name: 自動バージョンバンプ
    runs-on: ubuntu-latest
    # バージョンバンプコミット自体では実行しない（無限ループ防止）
    if: "!contains(github.event.head_commit.message, 'chore(version):')"
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Linux 依存パッケージのインストール
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libwayland-dev \
            libxkbcommon-dev

      - name: Rust ツールチェーンのセットアップ
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cocogitto のインストール
        run: cargo install cocogitto

      - name: cargo-edit のインストール
        run: cargo install cargo-edit

      - name: Git 設定
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: テストとビルドチェック
        run: |
          cargo test
          cargo clippy -- -D warnings

      - name: バージョンバンプ
        id: bump
        run: |
          # バージョンタイプの決定
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ inputs.version_type }}"
          else
            VERSION_TYPE="auto"
          fi

          echo "バージョンタイプ: $VERSION_TYPE"

          if [ "$VERSION_TYPE" = "auto" ]; then
            BUMP_CMD="cog bump --auto --skip-ci"
          else
            BUMP_CMD="cog bump --$VERSION_TYPE --skip-ci"
          fi

          BUMP_OUTPUT=$(mktemp)
          if $BUMP_CMD 2>&1 | tee "$BUMP_OUTPUT"; then
            echo "バージョンバンプ成功"
            NEW_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || git tag --sort=-v:refname | head -n1)
            echo "新しいバージョン: $NEW_VERSION"
            echo "bumped=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            if grep -q "No conventional commits for your repository that required a bump" "$BUMP_OUTPUT"; then
              echo "バンプが必要なコミットがありません"
              echo "bumped=false" >> $GITHUB_OUTPUT
            else
              echo "バージョンバンプ失敗"
              cat "$BUMP_OUTPUT"
              exit 1
            fi
          fi
          rm -f "$BUMP_OUTPUT"

      - name: Cargo.toml バージョン確認
        if: steps.bump.outputs.bumped == 'true'
        run: |
          echo "Cargo.tomlのバージョン:"
          grep '^version = ' Cargo.toml

      - name: 変更をプッシュ
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git push origin main
          git push --tags
